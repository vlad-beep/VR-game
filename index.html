<html>

<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script>

        AFRAME.registerComponent('bullet', {
            schema: {
                velocity: { type: 'vec3', default: { x: 0, y: 0, z: -5 } }
            },

            init: function () {
                this.el.addEventListener('componentchanged', (event) => {
                    if (event.detail.name === 'position') {
                        this.checkCollision();
                    }
                });
            },

            tick: function () {
                const position = this.el.getAttribute('position');
                const velocity = this.data.velocity;
                position.x += velocity.x * 0.016;
                position.y += velocity.y * 0.016;
                position.z += velocity.z * 0.016;
                this.el.setAttribute('position', position);
            },

            checkCollision: function () {
                // Ничего не делаем здесь, обработка столкновений в логике ниже
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === ' ') { // Проверяем, была ли нажата клавиша пробела
                const camera = document.querySelector('a-camera'); // Получаем элемент камеры
                const cursor = document.querySelector('[cursor]'); // Получаем элемент курсора
                const velocity = 10;
                // Получаем позиции камеры и курсора
                const cameraPosition = new THREE.Vector3();
                camera.object3D.getWorldPosition(cameraPosition);

                const cursorPosition = new THREE.Vector3();
                cursor.object3D.getWorldPosition(cursorPosition);

                // Вычисляем вектор от камеры к курсору
                const direction = new THREE.Vector3();
                direction.subVectors(cursorPosition, cameraPosition).normalize(); // Нормализуем вектор

                // Создаем красную сферу (пулю) и задаем ей начальную позицию и цвет
                const bullet = document.createElement('a-sphere');
                bullet.setAttribute('radius', '0.05');
                bullet.setAttribute('position', cameraPosition); // Начальная позиция пули равна позиции камеры
                bullet.setAttribute('color', 'red');
                bullet.setAttribute('bullet', '');
                bullet.setAttribute('raycaster', {
                    direction: direction,
                    far: 1, // Увеличьте значение far по вашему усмотрению
                    interval: 50, // Увеличьте интервал проверки
                });

                // Устанавливаем направление пули
                bullet.setAttribute('bullet', `velocity: ${direction.x * velocity} ${direction.y * velocity} ${direction.z * velocity}`);

                // Добавляем пулю на сцену
                const scene = document.querySelector('a-scene');
                scene.appendChild(bullet);
                const timer = setTimeout(() => {
                    scene.removeChild(bullet); // Удаляем пулю
                }, 3000);


                // Используем raycaster для обнаружения столкновения с сферой-мишенью
                const raycaster = new THREE.Raycaster(cameraPosition, direction);
                const intersects = raycaster.intersectObject(scene.object3D, true);

                if (intersects.length > 0.1) {
                    const target = intersects[0].object.el;
                    if (target.id === 'target') {
                        const target = document.querySelector('#target');
                        const targetPosition = new THREE.Vector3();
                        target.object3D.getWorldPosition(targetPosition);
                        const distance = cameraPosition.distanceTo(targetPosition);

                        // Вычисляем время, через которое мишень исчезнет
                        const timeToDisappear = distance / velocity;
                        console.log('Попадание!');

                        // Задержка перед удалением мишени на основе вычисленного времени
                        setTimeout(() => {
                            scene.removeChild(target); // Удаляем сферу-мишень
                            scene.removeChild(bullet);
                        }, timeToDisappear * 1000); // Умножаем на 1000, чтобы перевести в миллисекунды
                    }
                }
            }
        });
    </script>
</head>

<body>
    <a-scene>
        <a-assets>
            <a-asset-item id="targetModel" src="/assets/textures/abstract_shape.glb"></a-asset-item>
            <a-asset-item id="impactModel" src="/assets/textures/firelings.glb"></a-asset-item>
            <a-mixin id="snow-particle" particle-system="preset: snow; particleCount: 1000;"></a-mixin>
        </a-assets>
        <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
        <a-sky src="/assets/images/BackGround.jpg" radius="20"></a-sky>
        <a-camera raycaster="objects: [data-raycastable]">
            <a-cursor></a-cursor>
        </a-camera>
        <a-entity explosion></a-entity>
        <a-entity id="target" position="0 5 -14" scale="10 10 10" shadow="cast: true" gltf-model="#targetModel"
            data-raycastable
            animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true;"></a-entity>
    </a-scene>
</body>

</html>